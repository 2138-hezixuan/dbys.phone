name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.0'
        cache: 'npm'
        
    - name: Check Node.js version
      run: |
        echo "Node.js version:"
        node --version
        echo "npm version:"
        npm --version
        
    - name: Clean and install dependencies
      run: |
        # 彻底清理缓存和旧文件
        npm cache clean --force
        rm -rf node_modules 2>/dev/null || true
        rm -f package-lock.json 2>/dev/null || true
        
        # 安装基础依赖
        npm install --legacy-peer-deps
        
        # 安装所有必需的 PostCSS 插件
        npm install --save-dev postcss postcss-flexbugs-fixes postcss-preset-env autoprefixer cssnano
        
    - name: Create comprehensive PostCSS config
      run: |
        # 创建完整的 PostCSS 配置文件
        cat > postcss.config.js << 'EOF'
        module.exports = {
          plugins: [
            'postcss-flexbugs-fixes',
            [
              'postcss-preset-env',
              {
                autoprefixer: {
                  flexbox: 'no-2009',
                },
                stage: 3,
                features: {
                  'custom-properties': false,
                  'nesting-rules': true
                },
              },
            ],
            [
              'autoprefixer',
              {
                grid: true
              }
            ],
          ],
        }
        EOF
        
        echo "PostCSS配置文件已创建:"
        cat postcss.config.js
        
        # 如果项目中已经有 postcss.config.js，备份它
        if [ -f "postcss.config.js.original" ]; then
          echo "发现原始PostCSS配置，已备份"
        fi
        
    - name: Check CSS file syntax
      run: |
        echo "检查CSS文件..."
        if [ -f "app/globals.css" ]; then
          echo "globals.css 文件存在，行数:"
          wc -l app/globals.css
          
          echo "前20行内容:"
          head -20 app/globals.css
        else
          echo "警告: 未找到 app/globals.css"
          find . -name "*.css" -type f | head -5
        fi
        
    - name: Fix potential CSS issues
      run: |
        # 如果CSS文件中有未来语法，尝试修复
        if [ -f "app/globals.css" ]; then
          # 备份原始文件
          cp app/globals.css app/globals.css.backup
          
          # 移除可能的错误语法（示例）
          # sed -i 's/@custom-media//g' app/globals.css 2>/dev/null || true
          
          echo "CSS文件已备份"
        fi
        
    - name: Build with debug info
      run: |
        echo "开始构建项目..."
        
        # 设置环境变量以便更好的错误报告
        export NODE_OPTIONS="--max-old-space-size=4096"
        export DEBUG="next:*"
        
        # 清理之前的构建
        rm -rf .next 2>/dev/null || true
        
        # 尝试构建
        if npm run build 2>&1; then
          echo "构建成功!"
        else
          echo "构建失败，尝试替代构建方案..."
          
          # 如果标准构建失败，尝试使用不同的方法
          echo "尝试使用更兼容的模式构建..."
          npx next build --debug 2>&1 || echo "构建失败，请检查错误信息"
        fi
        
        # 检查构建输出
        if [ -d ".next" ]; then
          echo "构建输出目录内容:"
          ls -la .next/
        fi
        
        # 如果有export脚本，执行它
        if grep -q '"export"' package.json; then
          echo "执行export..."
          npm run export 2>&1 || echo "export失败"
        fi
        
    - name: Prepare for deployment
      run: |
        # 确定输出目录
        if [ -d "out" ]; then
          OUTPUT_DIR="out"
        elif [ -d ".next" ]; then
          OUTPUT_DIR=".next"
          # 复制静态文件到正确位置
          if [ -d ".next/static" ]; then
            echo "Next.js 静态目录存在"
          fi
        else
          echo "警告: 未找到标准输出目录"
          OUTPUT_DIR="."
        fi
        
        echo "输出目录: $OUTPUT_DIR"
        
        # 创建.nojekyll文件
        touch $OUTPUT_DIR/.nojekyll 2>/dev/null || true
        
        # 显示输出目录结构
        echo "输出目录结构:"
        find $OUTPUT_DIR -type f -name "*.html" | head -10
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./out
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        
    - name: Verify deployment
      run: |
        echo "部署完成！"
        echo "网站地址: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "如果遇到问题，请检查:"
        echo "1. GitHub仓库的Settings → Pages"
        echo "2. Actions日志中的错误信息"